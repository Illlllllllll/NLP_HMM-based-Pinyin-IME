# IME 输入法 UI 设计文档

## 概述
这是一个增量式拼音输入法应用，采用类似系统输入法的交互模式。

## UI 行为规范

### 1. 默认状态（无输入）
- **显示**: 静态图片 (serena.jpg) 全屏显示
- **文本框**: 完全隐藏
- **候选框**: 完全隐藏
- **交互**: 点击图片打开设置弹窗

### 2. 输入状态（键盘输入时）
- **图片**: 缩小显示在上方 (380x300)
- **输入框**: 自动显示在图片下方
  - 显示当前拼音输入
  - 支持空格分词
  - 支持退格删除
- **候选框**: 实时显示在输入框下方
  - 最多显示 5 个候选（可配置）
  - 每个候选带数字编号 (1-5)
  - 候选按分数降序排列

### 3. 输出区域
- **位置**: 窗口底部
- **功能**: 显示已确认上屏的文本
- **样式**: 浅色背景，圆角边框

## 交互逻辑

### 键盘输入
- **字母键 (a-z)**: 追加到当前拼音缓冲区
- **空格键**: 确认当前拼音分词，触发解码
- **回车键**: 上屏当前最佳候选
- **退格键**: 删除最后一个字符或拼音
- **ESC 键**: 清空所有输入
- **数字键 (1-9)**: 快速选择对应候选

### 候选选择
- **点击按钮**: 选择该候选并上屏
- **数字快捷键**: 快速选择（1 对应第一个候选）

### 设置
- **触发**: 点击默认状态下的图片
- **内容**:
  - Beam Size: 控制解码搜索空间大小
  - 候选数量: 控制显示的候选个数 (1-9)

## 视觉规范

### 颜色方案
- **主色**: #3b82f6 (蓝色 - 输入框边框)
- **背景**: #111827 (深色 - 图片背景)
- **候选背景**: #f3f4f6 (浅灰)
- **候选悬停**: #e5e7eb (中灰)
- **输出背景**: #f9fafb (极浅灰)

### 字体
- **拼音输入**: 16pt Consolas
- **候选文字**: 14pt
- **输出文字**: 12pt
- **默认字体**: Microsoft YaHei / 系统默认

### 布局
- **窗口大小**: 400x600 (固定)
- **图片大小**: 
  - 默认状态: 380x500
  - 输入状态: 380x300
- **输入框高度**: 40px
- **候选按钮**: 70x40px
- **输出区域**: 最小 60px，自适应内容

## 核心技术特性

### 增量式解码
- **状态保持**: 维护历史 DP 状态，避免重复计算
- **实时更新**: 每输入一个字符即刷新候选
- **前缀预测**: 支持未完成拼音的候选预测
- **Beam Search**: 控制状态空间，保证性能

### 性能优化
- **Beam Size 剪枝**: 每步只保留 Top-N 状态（默认 100）
- **惰性计算**: 只在需要时计算候选
- **缓存机制**: 复用已计算的中间状态

## 使用场景示例

### 场景 1: 基础输入
1. 用户按下 'n' → 输入框显示，候选出现（如"你"、"尼"、"呢"等）
2. 用户继续按 'i' → 输入框显示 "ni"，候选更新
3. 用户按空格 → 确认拼音 "ni"，候选变为完整词
4. 用户按 'h' 'a' 'o' → 实时显示候选（如"你好"、"你号"等）
5. 用户按 '1' 或回车 → 上屏"你好"，输入框隐藏

### 场景 2: 快速输入
1. 用户快速输入 "nihao" → 实时显示前缀匹配的候选
2. 用户按空格两次 → 确认为 "ni hao" 两个拼音
3. 系统显示最佳候选 "你好"
4. 用户按回车 → 上屏

### 场景 3: 修改输入
1. 用户输入 "niha"
2. 发现错误，按退格两次 → 变为 "ni"
3. 重新输入 "hao" → 显示正确候选
4. 选择上屏

### 场景 4: 设置调整
1. 默认状态下，用户点击图片
2. 弹出设置对话框
3. 调整 Beam Size 和候选数量
4. 点击确定 → 设置生效

## 文件说明

### 主要文件
- **IMEApp.py**: 主应用程序
- **src/decoder/viterbi.py**: 包含 `IncrementalViterbi` 增量解码器
- **src/models/hmm.py**: HMM 参数定义和加载
- **resources/**: 预构建的词典和模型文件

### 依赖资源
- **lexicon_aggregate.json**: 拼音-汉字映射词典
- **hmm_params.json**: HMM 参数（初始、转移、发射概率）
- **serena.jpg**: 默认显示图片

## 运行方式

```bash
# 确保资源已构建
python UserApp.py  # 首次运行，构建资源

# 运行 IME 应用
python IMEApp.py
```

## 技术栈
- **UI 框架**: PyQt6
- **解码算法**: Viterbi + Beam Search
- **概率模型**: HMM (Hidden Markov Model)
- **数据结构**: 动态规划表 + 回溯指针

## 未来扩展
- [ ] 用户词库自学习
- [ ] 云词库同步
- [ ] 智能纠错
- [ ] 表情和符号输入
- [ ] 皮肤主题切换
